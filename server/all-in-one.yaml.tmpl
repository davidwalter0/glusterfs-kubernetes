# kind: List
# apiVersion: v1
# items:
---
kind: ServiceAccount
apiVersion: v1
metadata:
  name: glusterfs

######## ---
######## kind: SecurityContextConstraints
######## apiVersion: v1
######## metadata: 
########   name: glusterfs
########   labels: 
########     name: glusterfs
######## allowPrivilegedContainer: true
######## allowHostDirVolumePlugin: true
######## allowedCapabilities:
######## - SYS_ADMIN
######## runAsUser: 
########   type: RunAsAny
######## seLinuxContext: 
########   type: RunAsAny
######## users: 
######## - system:serviceaccounts:default:glusterfs
######## groups: 
######## - system:cluster-admins

---
kind: Service
apiVersion: v1
metadata:
  name: {{env "GFS_SERVICE"}}
  namespace: {{env "NAMESPACE"}}
spec:
  ports:
  - name: ssh
    port: 2222
    targetPort: 2222
  - name: glusterfs-api
    port: 24007
    targetPort: 24007
  - name: glusterfs-infiniband
    port: 24008
    targetPort: 24008
  - name: glusterfs-brick0
    port: 49152
    targetPort: 49152
  - name: glusterfs-nfs-0
    port: 38465
    targetPort: 38465
  - name: glusterfs-nfs-1
    port: 38466
    targetPort: 38466
  - name: glusterfs-nfs-2
    port: 38467
    targetPort: 38467
  - name: nfs-rpc
    port: 111
    targetPort: 111
  - name: nfs-rpc-udp
    port: 111
    targetPort: 111
    protocol: UDP
  - name: nfs-portmap
    port: 2049
    targetPort: 2049
  selector:
    app: {{env "GFS_STORAGE"}}
---
kind: StatefulSet
apiVersion: apps/v1beta1
metadata:
  labels:
    component: {{env "GFS_STORAGE"}}
  name: {{env "GFS_STORAGE"}}
  namespace: {{env "NAMESPACE"}}
spec:
  serviceName: {{env "GFS_SERVICE"}}
  replicas: 2
  template:
    metadata:
      labels:
        app: {{env "GFS_STORAGE"}}
    spec:
      nodeSelector:
        gluster.io/schedulable: "true"
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                - key: "gluster.io/schedulable"
                  operator: In
                  values: ["true"]
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values: ['{{env "GFS_STORAGE"}}']
            topologyKey: 'kubernetes.io/hostname'
      serviceAccount: glusterfs
      containers:
      - name: {{env "GFS_SERVER_NAME"}}
        image: {{env "GFS_SERVER_IMAGE"}}
        resources:
          requests:
            memory: "64Mi"
            cpu: "250m"
          limits:
            memory: "128Mi"
            cpu: "500m"
        securityContext:
          privileged: true
        ports:
        - containerPort: {{env "SSH_PORT"}}
        - containerPort: 24007
        - containerPort: 24008
        - containerPort: 49152
        - containerPort: 38465
        - containerPort: 38466
        - containerPort: 38467
        - containerPort: 2049
        - containerPort: 111
        - containerPort: 111
          protocol: UDP
        env:
        - name: GLUSTER_VOLUME_TYPE
          value: distributed
        - name: GLUSTER_VOL
          value: shared0
        - name: GLUSTER_BRICK_PATH
          value: /gluster_volume
        - name: SERVICE_NAME
          value: {{env "GFS_SERVICE"}}.default.svc.cluster.local
        - name: ROOT_PASSWORD
          value: container_root_password
        - name: DEBUG
          value: "1"
        - name: SSH_PORT
          value: '{{env "SSH_PORT"}}'
        volumeMounts:
          - name: local0
            mountPath: /gluster_volume
      volumes:
        - name: local0
          emptyDir: {}

---
kind: Service
apiVersion: v1
metadata:
  name: {{env "GFS_CLIENT_NAME"}}
  namespace: {{env "NAMESPACE"}}
spec:
  ports:
  - name: ssh
    port: 2222
    targetPort: 2222
  selector:
    app: {{env "GFS_CLIENT_NAME"}}

---
kind: StatefulSet
apiVersion: apps/v1beta1
metadata:
  labels:
    component: {{env "GFS_CLIENT_NAME"}}
  name: {{env "GFS_CLIENT_NAME"}}
  namespace: {{env "NAMESPACE"}}
spec:
  serviceName: {{env "GFS_SERVICE"}}
  replicas: 2
  template:
    metadata:
      labels:
        app: {{env "GFS_CLIENT_NAME"}}
    spec:
      nodeSelector:
        gluster.io/schedulable: "true"
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                - key: "gluster.io/schedulable"
                  operator: In
                  values: ["true"]
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values: ['{{env "GFS_CLIENT_NAME"}}']
            topologyKey: 'kubernetes.io/hostname'
      serviceAccount: glusterfs
      containers:
      - name: {{env "GFS_CLIENT_NAME"}}
        image: {{env "GFS_CLIENT_IMAGE"}}
        ports:
        - containerPort: 2222
        resources:
          requests:
            memory: "64Mi"
            cpu: "250m"
          limits:
            memory: "128Mi"
            cpu: "500m"
        securityContext:
          privileged: true
        env:
        - name: GLUSTER_VOLUME_SERVER
          value: '{{env "GFS_SERVICE"}}.{{env "NAMESPACE"}}.svc.cluster.local'
        - name: GLUSTER_VOLUMEID
          value: '{{env "GLUSTER_VOL"}}'
        - name: GLUSTER_MOUNTPOINT
          value: '{{env "GLUSTER_BRICK_PATH"}}/{{env "GLUSTER_VOL"}}'
        volumeMounts:
          - name: {{env "GLUSTER_VOL"}}
            mountPath: '{{env "GLUSTER_BRICK_PATH"}}'
      volumes:
        - name: {{env "GLUSTER_VOL"}}
          emptyDir: {}


# local variables:
# mode: yaml
# end:
